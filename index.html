<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>شبیه‌ساز بازی موشک — فقط برای تفریح</title>
<style>
  :root{--bg:#0f1724;--card:#0b1220;--accent:#10b981;--text:#e6eef8;}
  body{background:linear-gradient(180deg,#071025 0%, #0b1220 100%);color:var(--text);font-family: "Tahoma", "Segoe UI", Arial;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}
  .app{width:420px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));padding:18px;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.6)}
  h1{font-size:18px;margin:0 0 12px;text-align:center}
  .row{display:flex;gap:8px;margin-bottom:10px;align-items:center}
  label{font-size:12px;color:#9fb3c9;min-width:80px}
  input[type="number"]{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.05);background:transparent;color:var(--text)}
  button{padding:10px 12px;border-radius:8px;border:none;background:var(--accent);color:#042018;font-weight:600;cursor:pointer}
  button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
  .display{background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;text-align:center;margin-bottom:10px}
  .mult{font-size:28px;font-weight:700}
  .status{font-size:13px;color:#9fb3c9}
  .progress{height:10px;background:rgba(255,255,255,0.03);border-radius:999px;overflow:hidden;margin-top:8px}
  .progbar{height:100%;width:0%;background:linear-gradient(90deg, rgba(16,185,129,0.8), rgba(16,185,129,0.4))}
  .controls{display:flex;gap:8px}
  .history{max-height:120px;overflow:auto;margin-top:10px;padding:8px;background:rgba(255,255,255,0.01);border-radius:8px;font-size:13px}
  .note{font-size:12px;color:#ffd2a6;margin-top:8px;text-align:center}
  .big{font-size:20px;font-weight:700}
</style>
</head>
<body>
  <div class="app" dir="rtl">
    <h1>شبیه‌ساز بازی موشک (Crash) — پول تقلبی</h1>

    <div class="display">
      <div class="row">
        <label>موجودی:</label>
        <div class="big" id="balance">50,000,000</div>
      </div>
      <div class="row">
        <label>شرط (تومان):</label>
        <input id="bet" type="number" min="1" step="1000" value="100000" />
      </div>
      <div class="row">
        <label>وضعیت:</label>
        <div class="status" id="status">آماده</div>
      </div>
    </div>

    <div class="display">
      <div class="mult" id="multiplier">x1.00</div>
      <div class="progress"><div id="prog" class="progbar"></div></div>
      <div style="margin-top:8px;display:flex;gap:8px" class="controls">
        <button id="startBtn">شروع راند</button>
        <button id="cashBtn" class="secondary" disabled>برداشت (Cash Out)</button>
        <button id="resetBtn" class="secondary">ریست پول</button>
      </div>
      <div class="note">تذکر: این بازی فقط شبیه‌ساز است و با پول تقلبی کار می‌کند.</div>
    </div>

    <div class="history" id="history">
      <div style="font-weight:700;margin-bottom:8px">تاریخچه اخیر</div>
    </div>

  </div>

<script>
// حالت اولیه
let balance = 50000000; // 50,000,000
let betInput = document.getElementById('bet');
let balanceEl = document.getElementById('balance');
let statusEl = document.getElementById('status');
let multiplierEl = document.getElementById('multiplier');
let startBtn = document.getElementById('startBtn');
let cashBtn = document.getElementById('cashBtn');
let resetBtn = document.getElementById('resetBtn');
let prog = document.getElementById('prog');
let historyEl = document.getElementById('history');

let running = false;
let crashPoint = 0;
let currentMult = 1.0;
let rafId = null;
let startTime = 0;
let stake = 0;
let cashedOut = false;

function fmt(n){
  return n.toLocaleString('fa-IR');
}

function updateBalanceUI(){ balanceEl.textContent = fmt(balance); }
updateBalanceUI();

function randomCrash(){
  // تولید تصادفی نقطه کرش بین 0 و 50. 
  // برای طبیعی‌تر شدن، توزیع را کمی سنگین به سمت اعداد پایین قرار می‌دهیم:
  // استفاده از توزیع نمایی معکوس: 1/(1 - u*0.98) تا احتمال ارقام کوچک بیشتر شود
  let u = Math.random();
  // تبدیل به بازه [0,50)
  let v = Math.pow(u, 1.3) * 50; // شیب دلخواه؛ افزایش توان => کمتر احتمال بالا رفتن خیلی زیاد
  // برای افزودن امکان کرش کمتر از 1:
  if (Math.random() < 0.06) { // ~6% احتمال کرش زیر 1
    v = Math.random() * 0.99;
  }
  // حداکثر 50
  return Math.max(0, Math.min(50, parseFloat(v.toFixed(3))));
}

function startRound(){
  if (running) return;
  stake = Math.floor(Number(betInput.value) || 0);
  if (!stake || stake <= 0){ alert('مبلغ شرط معتبر نیست'); return; }
  if (stake > balance){ alert('مبلغ شرط بیشتر از موجودی است'); return; }

  // کم کردن شرط از موجودی (مثل قمارهای معمول)
  balance -= stake;
  updateBalanceUI();

  crashPoint = randomCrash();
  currentMult = 1.0;
  cashedOut = false;
  running = true;
  statusEl.textContent = 'در حال اجرا — مراقب باش قبل از کرش برداشت کنی!';
  multiplierEl.textContent = 'x1.00';
  prog.style.width = '0%';
  cashBtn.disabled = false;
  startBtn.disabled = true;

  // شروع انیمیشن براساس زمان برای شبیه‌سازی رشد سریع:
  startTime = performance.now();
  function frame(t){
    // رشد نمایی/تصاعدی برای حس واقعی‌تر (سرعت رشد افزایش می‌یابد)
    let dt = (t - startTime)/1000; // ثانیه از شروع
    // فرمول رشد: m = 1 * exp(k * dt) با k تنظیم شده به طور دینامیک
    // برای متنوع شدن rounds، از ضریب رشد متناسب با crashPoint استفاده می‌کنیم
    // به‌طور ساده: مقدار سرعت را طوری انتخاب می‌کنیم که در حدود crashPoint در بازه‌ای مناسب برسد
    let k = 0.7; // پایه رشد
    // اگر crashPoint خیلی کم باشد، رشد را کند کنیم
    if (crashPoint < 1) k = 0.5;
    // اگر crashPoint خیلی بزرگ است، رشد را کمی کندتر اما مداوم نگه می‌داریم
    if (crashPoint > 20) k = 0.55;

    currentMult = Math.exp(k * dt);

    // اطمینان از اینکه ضریب حداقل 1.00 و نمایش با دو رقم اعشار
    if (currentMult < 1) currentMult = 1;

    multiplierEl.textContent = 'x' + currentMult.toFixed(2);

    // درصد پروگرس براساس لگاریتم ساده تا پر شدن جلوه بدهیم (نه دقیقاً خطی)
    let progressPct = Math.min(100, (Math.log(currentMult) / Math.log(Math.max(2, Math.max(crashPoint,2)))) * 100);
    prog.style.width = progressPct + '%';

    // کرش شدن وقتی currentMult >= crashPoint
    if (currentMult >= crashPoint){
      // اگر crashPoint کمتر از 1، بلافاصله کرش نمایش داده شود
      endRound(false);
      return;
    }
    // ادامه انیمیشن
    rafId = requestAnimationFrame(frame);
  }
  rafId = requestAnimationFrame(frame);
}

function endRound(won){
  running = false;
  cancelAnimationFrame(rafId);
  rafId = null;
  startBtn.disabled = false;
  cashBtn.disabled = true;

  if (won){
    statusEl.textContent = 'برداشت موفق! پول به موجودی اضافه شد.';
  } else {
    statusEl.textContent = 'کرش شد — باختی.';
  }

  // ثبت تاریخچه
  let row = document.createElement('div');
  let cp = crashPoint.toFixed(2);
  let multText = currentMult ? currentMult.toFixed(2) : '1.00';
  row.innerHTML = `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,0.02)">
    <div>شرط ${fmt(stake)} → ${won ? 'برد x' + cashedMultiplier.toFixed(2) : 'کرش @ x' + cp}</div>
    <div style="opacity:0.8">${new Date().toLocaleTimeString('fa-IR')}</div>
  </div>`;
  historyEl.insertBefore(row, historyEl.children[1]);

  // اگر کاربر برداشت کرده بود و برنده شد، مبلغ به موجودی اضافه کن
  if (won){
    balance += Math.floor(stake * cashedMultiplier);
    updateBalanceUI();
  } else {
    // باخت: چیزی برای اضافه کردن نیست (شرط از قبل کم شده)
    updateBalanceUI();
  }
}

// برداشت دستی
let cashedMultiplier = 1.0;
cashBtn.addEventListener('click', ()=>{
  if (!running) return;
  // مقدار فعلی ضریب را قفل کن
  cashedMultiplier = parseFloat(currentMult.toFixed(2));
  cashedOut = true;
  endRound(true);
});

// شروع راند
startBtn.addEventListener('click', ()=>{
  startRound();
});

// ریست موجودی به مقدار اولیه
resetBtn.addEventListener('click', ()=>{
  if (confirm('آیا مایلید موجودی به 50,000,000 بازگردد؟')) {
    balance = 50000000;
    updateBalanceUI();
    historyEl.innerHTML = '<div style="font-weight:700;margin-bottom:8px">تاریخچه اخیر</div>';
    statusEl.textContent = 'ریست شد';
  }
});

// در صورتی که کرشِ خیلی کم باشد (crashPoint < 1)، باید فوراً کرش شود.
// تابع endRound صدا زده می‌شود از داخل فریم.
</script>
</body>
</html>
